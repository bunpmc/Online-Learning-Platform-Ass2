@page "/Course/Learn/{id:guid}"
@model OnlineLearningPlatformAss2.RazorWebApp.Pages.Course.LearnModel

@{
    ViewData["Title"] = Model.CourseLearn?.CourseTitle ?? "Course Learning";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - LearnHub</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/course-learn.css" asp-append-version="true" />
</head>

<body>
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger m-3">
            @Model.ErrorMessage
            <a asp-page="/Course/MyCourses" class="btn btn-sm btn-outline-danger ms-3">Back to My Courses</a>
        </div>
    }

    @if (Model.CourseLearn != null)
    {
        <div class="d-flex flex-column h-100">
            <!-- Top Header -->
            <header class="course-header-bar d-flex align-items-center justify-content-between px-4 py-2 bg-white border-bottom">
                <div class="d-flex align-items-center">
                    <a asp-page="/Course/MyCourses" class="text-decoration-none text-dark me-3">
                        <i class="bi bi-arrow-left fs-5"></i>
                    </a>
                    <div>
                        <h1 class="h6 mb-0 fw-bold">@Model.CourseLearn.CourseTitle</h1>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex flex-column align-items-end">
                        <span class="small text-muted mb-1">Your Progress: <span id="progressText" class="fw-bold text-success">@Model.CourseLearn.Progress%</span></span>
                        <div class="progress" style="width: 150px; height: 6px;">
                            <div id="courseProgressBar" class="progress-bar bg-success" role="progressbar" style="width: @Model.CourseLearn.Progress%" aria-valuenow="@Model.CourseLearn.Progress" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <a href="/Certificates/View/@Model.CourseLearn.CertificateId" id="certificateBtn" class="btn btn-outline-success btn-sm @(Model.CourseLearn.Progress < 100 ? "d-none" : "")" target="_blank">
                        <i class="bi bi-patch-check me-1"></i> Certificate
                    </a>
                </div>
            </header>

            <div class="container-fluid bg-light h-100 p-0">
                <div class="row h-100 g-0">
                    <!-- Main Content (Video & Tabs) - Left Side -->
                    <main class="col-lg-9 col-md-8 h-100 overflow-auto scroll-smooth">
                        <div class="p-4 mx-auto" style="max-width: 1200px;">
                            
                            <!-- Video Section -->
                            <div class="video-card bg-black rounded-4 shadow-sm overflow-hidden mb-4">
                                <div class="video-container w-100" id="videoContainer">
                                    @if (!string.IsNullOrEmpty(Model.CourseLearn.CurrentLesson?.VideoUrl))
                                    {
                                        <div class="ratio ratio-16x9">
                                            <iframe src="@Model.CourseLearn.CurrentLesson.VideoUrl" allowfullscreen></iframe>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="d-flex align-items-center justify-content-center ratio ratio-16x9 bg-light text-secondary">
                                            <div class="text-center">
                                                <i class="bi bi-file-text display-1 mb-3"></i>
                                                <p class="h5">Included Reading Material</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Lesson Info & Actions -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h2 class="h4 fw-bold mb-1" id="lessonTitle">@(Model.CourseLearn.CurrentLesson?.Title ?? "Select a Lesson")</h2>
                                    <p class="text-muted small mb-0">
                                        Author: <span class="fw-bold text-dark">@Model.CourseLearn.CourseTitle</span>
                                    </p>
                                </div>
                                <div class="d-flex gap-2">
                                     <button class="btn btn-light border-0 rounded-circle p-2" title="Favorite">
                                        <i class="bi bi-heart"></i>
                                    </button>
                                    <button class="btn btn-light border-0 rounded-circle p-2" title="Share">
                                        <i class="bi bi-share"></i>
                                    </button>
                                    @if (Model.CourseLearn.Progress >= 100)
                                    {
                                        <a href="/Certificates/View/@Model.CourseLearn.CertificateId" id="certificateBtnMain" class="btn btn-outline-primary rounded-pill px-4" target="_blank">
                                            Certificate
                                        </a>
                                    }
                                    <button class="btn btn-primary rounded-pill px-4" id="markCompleteBtn" onclick="markAsCompleted()">
                                        Next Lesson <i class="bi bi-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div class="bg-white rounded-4 shadow-sm p-4">
                                <ul class="nav nav-pills mb-4 gap-2" id="courseTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active rounded-pill px-4" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link rounded-pill px-4" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">AI Summary</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link rounded-pill px-4" id="qa-tab" data-bs-toggle="tab" data-bs-target="#qa" type="button" role="tab">Q&A</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link rounded-pill px-4" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews</button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="courseTabsContent">
                                    <!-- Overview Tab -->
                                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                         <div class="lesson-description text-secondary" id="lessonDescription">
                                            @Html.Raw(Model.CourseLearn.CurrentLesson?.Content ?? "Please select a lesson to start learning.")
                                        </div>
                                         <!-- Quiz Section -->
                                        <div id="quizSection" class="mt-5 d-none">
                                            <div class="card border-0 bg-light rounded-4">
                                                <div class="card-body p-4">
                                                    <h5 class="fw-bold text-primary mb-3">Lesson Quiz</h5>
                                                    <div id="quizContent"></div>
                                                    <div id="quizResult" class="mt-3 d-none"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- AI Summary Tab -->
                                    <div class="tab-pane fade" id="summary" role="tabpanel">
                                        <div class="text-center py-4" id="summaryLoading" style="display:none;">
                                            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                                            <p class="mt-2 text-muted">Generating AI Summary & Analyzing Video...</p>
                                        </div>
                                        <div id="summaryContent" class="fs-6 lh-lg text-dark mb-4"></div>
                                        <div class="text-center mb-4" id="generateSummaryBtnContainer">
                                             <button class="btn btn-primary rounded-pill px-4" onclick="generateSummary()">
                                                <i class="bi bi-magic me-2"></i>Generate Video Summary
                                             </button>
                                        </div>
                                        
                                        <hr class="my-4 text-muted">
                                        
                                        <h5 class="fw-bold mb-3"><i class="bi bi-robot me-2 text-primary"></i>Ask AI about this video</h5>
                                        <div class="input-group mb-3">
                                            <input type="text" id="aiQuestionInput" class="form-control rounded-start-pill ps-3" placeholder="Ask about concepts, timestamps, etc.">
                                            <button class="btn btn-outline-primary rounded-end-pill px-4" type="button" onclick="askAi()">Ask</button>
                                        </div>
                                        <div id="aiAnswer" class="bg-light p-3 rounded-3 d-none border-start border-4 border-primary">
                                            <h6 class="fw-bold text-primary mb-1">AI Answer:</h6>
                                            <p class="mb-0 text-secondary" id="aiAnswerText"></p>
                                        </div>
                                    </div>
                                    <!-- Q&A & Reviews (Keep inner content similar but Ensure ID matches) -->
                                    <div class="tab-pane fade" id="qa" role="tabpanel">
                                        <!-- ... Q&A Content ... -->
                                         <div class="card border-light shadow-sm mb-4">
                                            <div class="card-body">
                                                <h6 class="fw-bold mb-3">Ask a question</h6>
                                                <textarea id="commentInput" class="form-control mb-3 scroll-smooth" rows="3" placeholder="What requires clarification?"></textarea>
                                                <div class="d-flex justify-content-end">
                                                    <button class="btn btn-primary px-4 rounded-pill" id="postCommentBtn" onclick="submitComment()">Post Question</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="commentsList" class="ps-2"></div>
                                    </div>
                                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                                         <div class="text-center py-5">
                                            <p class="text-muted">Reviews are available after completing the course.</p>
                                            @if (Model.CourseLearn?.Progress >= 100)
                                            {
                                                <button class="btn btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#reviewModal">Write a Review</button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </main>

                    <!-- Sidebar (Course Content) - Right Side -->
                     <aside class="col-lg-3 col-md-4 bg-white border-start h-100 d-flex flex-column shadow-sm z-1">
                        <div class="p-4 border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2">Full Course</span>
                                <span class="fw-bold text-dark">@Model.CourseLearn.Progress%</span>
                            </div>
                            <h5 class="fw-bold mb-4">Course Content</h5>
                            
                             <div class="input-group input-group-sm mb-0">
                                <span class="input-group-text bg-light border-end-0 rounded-start-pill ps-3"><i class="bi bi-search"></i></span>
                                <input type="text" id="lessonSearch" class="form-control bg-light border-start-0 rounded-end-pill" placeholder="Search lessons..." oninput="filterLessons()">
                            </div>
                        </div>
                        
                        <div class="flex-grow-1 overflow-auto custom-scrollbar p-3">
                            <div class="course-timeline">
                                @for (int i = 0; i < Model.CourseLearn.Modules.Count; i++)
                                {
                                    var module = Model.CourseLearn.Modules[i];
                                    <div class="module-group mb-4">
                                        <h6 class="text-uppercase text-muted small fw-bold mb-3 ps-2">Module @(i + 1): @module.Title</h6>
                                        <div class="list-group list-group-flush">
                                            @foreach (var lesson in module.Lessons)
                                            {
                                                <div class="lesson-card p-3 mb-2 rounded-3 border-0 d-flex align-items-center justify-content-between cursor-pointer @(lesson.IsCurrent ? "bg-primary-subtle" : "bg-light")"
                                                     id="lesson-@lesson.Id"
                                                     onclick="selectLesson('@lesson.Id')">
                                                    <div class="d-flex align-items-center gap-3">
                                                        <div class="icon-box rounded-circle d-flex align-items-center justify-content-center @(lesson.IsCurrent ? "bg-primary text-white" : (lesson.IsCompleted ? "bg-success text-white" : "bg-white text-secondary border"))" style="width: 32px; height: 32px; min-width: 32px;">
                                                             @if (lesson.IsCompleted) { <i class="bi bi-check"></i> }
                                                             else if (lesson.IsCurrent) { <i class="bi bi-play-fill"></i> }
                                                             else { <i class="bi bi-lock-fill" style="font-size: 0.8rem;"></i> }
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0 small fw-bold @(lesson.IsCurrent ? "text-primary" : "text-dark")">@lesson.Title</h6>
                                                        </div>
                                                    </div>
                                                    <span class="small text-muted">@lesson.FormattedDuration</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                         <div class="p-4 border-top bg-light">
                            <a asp-page="/Course/MyCourses" class="btn btn-outline-dark w-100 rounded-pill fw-bold">Back to Courses</a>
                        </div>
                    </aside>
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold">Rate this course</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4 text-center">
                        <div class="mb-4">
                            <h4 class="mt-2 fw-bold">How was your learning experience?</h4>
                            <p class="text-muted small">Your feedback helps us improve the course content.</p>
                        </div>
                        <div class="rating-input mb-4">
                            <div class="star-rating h1 text-warning gap-2 d-flex justify-content-center">
                                <i class="bi bi-star rating-star" data-rating="1"></i>
                                <i class="bi bi-star rating-star" data-rating="2"></i>
                                <i class="bi bi-star rating-star" data-rating="3"></i>
                                <i class="bi bi-star rating-star" data-rating="4"></i>
                                <i class="bi bi-star rating-star" data-rating="5"></i>
                            </div>
                            <input type="hidden" id="selectedRating" value="0">
                        </div>
                        <div class="mb-3 text-start">
                            <label class="form-label fw-bold small text-uppercase text-muted">Review</label>
                            <textarea id="reviewComment" class="form-control" rows="4" placeholder="Tell us what you liked or what could be improved..."></textarea>
                        </div>
                        <button class="btn btn-primary w-100 py-2 fw-bold" onclick="submitReview()">Submit Review</button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
         <div class="d-flex align-items-center justify-content-center vh-100 bg-light">
            <div class="text-center">
                <i class="bi bi-exclamation-circle display-1 text-muted mb-3"></i>
                <h2 class="h4 text-dark">Course Not Found</h2>
                <p class="text-secondary">The course you're trying to access could not be loaded.</p>
                <a asp-page="/Course/MyCourses" class="btn btn-primary mt-3">Back to My Courses</a>
            </div>
        </div>
    }



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript for interactivity
        const modulesData = @Json.Serialize(Model.CourseLearn?.Modules ?? new List<OnlineLearningPlatformAss2.Service.DTOs.Course.ModuleViewModel>());
        const lessonsMap = {};
        modulesData.forEach(module => {
            module.lessons.forEach(lesson => {
                lessonsMap[lesson.id] = lesson;
            });
        });

        let currentCourseId = '@(Model.CourseLearn?.CourseId)';
        let currentLessonId = '@(Model.CourseLearn?.CurrentLessonId)';

        document.addEventListener('DOMContentLoaded', function() {
            if ((!currentLessonId || !lessonsMap[currentLessonId]) && modulesData.length > 0 && modulesData[0].lessons.length > 0) {
                 const firstLesson = modulesData[0].lessons[0];
                 selectLesson(firstLesson.id);
            } 
            else if (currentLessonId && lessonsMap[currentLessonId]) {
                 const el = document.getElementById('lesson-' + currentLessonId);
                 if(el) {
                     el.scrollIntoView({ behavior: 'auto', block: 'center' });
                     const collapseId = el.closest('.accordion-collapse')?.id;
                     if (collapseId) {
                         const bsCollapse = new bootstrap.Collapse(document.getElementById(collapseId), { toggle: false });
                         bsCollapse.show();
                     }
                 }
            }
            // Load initial comments if lesson is selected
            if (currentLessonId) loadComments(currentLessonId);

            // Save progress on tab close
            window.addEventListener('beforeunload', function() {
                const video = document.getElementById('videoPlayer');
                if (video && !video.paused && currentLessonId) {
                    updateProgress(currentLessonId, video.currentTime);
                }
            });
        });

        async function selectLesson(lessonId) {
            const lesson = lessonsMap[lessonId];
            if (!lesson) return;

            currentLessonId = lessonId;
            
            // UI Updates
            document.getElementById('lessonTitle').textContent = lesson.title;
            const descEl = document.getElementById('lessonDescription');
            if(descEl) descEl.innerHTML = lesson.content;
            
            // Video Player
            const videoContainer = document.getElementById('videoContainer');
            const markCompleteBtn = document.getElementById('markCompleteBtn'); 

            if (lesson.videoUrl && lesson.videoUrl !== 'null' && lesson.videoUrl.trim() !== '') {
                if (lesson.videoUrl.includes('youtube.com/embed')) {
                    videoContainer.innerHTML = `<div class="ratio ratio-16x9"><iframe src="${lesson.videoUrl}" allowfullscreen></iframe></div>`;
                } else {
                    videoContainer.innerHTML = `
                        <div class="ratio ratio-16x9 bg-black">
                            <video id="videoPlayer" class="w-100 h-100" controls>
                                <source src="${lesson.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>`;
                    
                    const video = document.getElementById('videoPlayer');
                    
                    // Restore position if not completed, or start from beginning? 
                    // Usually resume is good even if completed.
                    if (lesson.lastWatchedPosition > 0) {
                        video.currentTime = lesson.lastWatchedPosition;
                    }

                    let lastUpdateTime = 0;
                    video.ontimeupdate = function() {
                        const now = Date.now();
                        // Update every 5 seconds OR if it's been a while since last update
                        if (now - lastUpdateTime > 5000 && !video.paused) { 
                            updateProgress(lessonId, video.currentTime);
                            lastUpdateTime = now;
                        }
                    };
                    video.onpause = function() {
                        // Avoid conflict with onended
                        if (!video.ended) {
                             updateProgress(lessonId, video.currentTime);
                        }
                    };
                    video.onended = async function() {
                        // Serialize updates to avoid DB concurrency issues (Unique violation on insert)
                        await updateProgress(lessonId, video.duration); // Ensure 100% position
                        markAsCompleted();
                    };
                }
                
                // Button Logic
                if(markCompleteBtn) {
                     markCompleteBtn.style.display = 'inline-block';
                     updateMarkCompleteButton(lesson.isCompleted);
                     
                     if (lesson.isCompleted) {
                         markCompleteBtn.onclick = function() { nextLesson(); }; 
                     } else {
                         markCompleteBtn.onclick = function() { markAsCompleted(); };
                     }
                }
            } else {
                videoContainer.innerHTML = `<div class="d-flex align-items-center justify-content-center py-5 bg-light text-secondary"><div class="text-center"><i class="bi bi-file-text display-1 mb-3"></i><p class="h5">Reading Material</p></div></div>`;
                if(markCompleteBtn) {
                     markCompleteBtn.style.display = 'inline-block';
                     updateMarkCompleteButton(lesson.isCompleted);

                     if (lesson.isCompleted) {
                         markCompleteBtn.onclick = function() { nextLesson(); };
                     } else {
                         markCompleteBtn.onclick = function() { markAsCompleted(); };
                     }
                }
            }

            // Highlight Active Lesson
            document.querySelectorAll('.lesson-card').forEach(item => {
                item.classList.remove('active-lesson');
                item.querySelector('.icon-box i').classList.remove('text-primary'); 
                // Restore default icon if not completed/current
                const icon = item.querySelector('.icon-box i');
                if(!icon.classList.contains('text-success') && !icon.classList.contains('text-primary')) {
                     icon.className = 'bi bi-play-circle text-muted'; // Default
                }
            });
            
            const selectedItem = document.getElementById('lesson-' + lessonId);
            if (selectedItem) {
                selectedItem.classList.add('active-lesson');
                const icon = selectedItem.querySelector('.icon-box i');
                if (!icon.classList.contains('text-success')) {
                    icon.className = 'bi bi-play-circle-fill text-primary';
                }
            }

            // Reset AI Tab
            const sumContent = document.getElementById('summaryContent');
            if(sumContent) sumContent.innerHTML = '';
            const genBtn = document.getElementById('generateSummaryBtnContainer');
            if(genBtn) genBtn.style.display = 'block';
            const aiAns = document.getElementById('aiAnswer');
            if(aiAns) aiAns.classList.add('d-none');
            const aiInp = document.getElementById('aiQuestionInput');
            if(aiInp) aiInp.value = '';

            // Initial sync (just to set LastViewedLessonId, don't overwrite position with 0 if just loading)
             // Check if we are switching lessons. If so, update LastViewed. 
             // IMPORTANT: Don't reset position to 0 here. Pass null for position to only update LastViewedLessonId
            updateLastViewed(lessonId); 
            loadComments(lessonId);
        }

        function updateMarkCompleteButton(isCompleted) {
            const btn = document.getElementById('markCompleteBtn');
            if (!btn) return;
            
            if (isCompleted) {
                btn.innerHTML = 'Next Lesson <i class="bi bi-arrow-right ms-2"></i>';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            } else {
                btn.innerHTML = 'Mark as Complete <i class="bi bi-check-lg ms-2"></i>';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            }
        }

        async function updateProgress(lessonId, position) {
             const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
             // Use keepalive for reliability on page unload
             try {
                await fetch('?handler=UpdateLastView', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ courseId: currentCourseId, lessonId: lessonId, position: Math.floor(position) }),
                    keepalive: true
                });
             } catch(e) { console.error("Sync failed", e); }
        }

        async function updateLastViewed(lessonId) {
             const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
             try {
                await fetch('?handler=UpdateLastView', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ courseId: currentCourseId, lessonId: lessonId, position: null }) 
                });
             } catch(e) { console.error("UpdateLastView failed", e); }
        }
        
        async function generateSummary() {
            document.getElementById('summaryLoading').style.display = 'block';
            document.getElementById('summaryContent').innerHTML = '';
            document.getElementById('generateSummaryBtnContainer').style.display = 'none';
            
            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('?handler=GenerateSummary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ courseId: currentCourseId, lessonId: currentLessonId })
                });
                const result = await response.json();
                document.getElementById('summaryContent').innerHTML = result.summary ? result.summary.replace(/\n/g, '<br>') : 'No summary available.';
            } catch(e) {
                document.getElementById('summaryContent').textContent = "Failed to generate summary.";
                document.getElementById('generateSummaryBtnContainer').style.display = 'block';
            } finally {
                document.getElementById('summaryLoading').style.display = 'none';
            }
        }
        
        async function askAi() {
            const q = document.getElementById('aiQuestionInput').value;
            if(!q) return;
            
            const ansText = document.getElementById('aiAnswerText');
            ansText.textContent = "AI is thinking...";
            document.getElementById('aiAnswer').classList.remove('d-none');
            
            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('?handler=AskAi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ courseId: currentCourseId, lessonId: currentLessonId, question: q })
                });
                const result = await response.json();
                ansText.textContent = result.answer;
            } catch(e) {
                ansText.textContent = "AI failed to respond. Please try again.";
            }
        }

        async function markAsCompleted() {
            const btn = document.getElementById('markCompleteBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('?handler=CompleteLesson', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({ courseId: currentCourseId, lessonId: currentLessonId })
                });

                if (!response.ok) {
                     const text = await response.text();
                     throw new Error(`Server Error (${response.status}): ${text}`);
                }

                const result = await response.json();
                if (result.success) {
                    const lessonKey = 'lesson-' + currentLessonId;
                    const lessonItem = document.getElementById(lessonKey);
                    
                    if (lessonItem) {
                        const icon = lessonItem.querySelector('.icon-box i');
                        icon.className = 'bi bi-check-circle-fill text-success';
                    }

                    const progressBar = document.getElementById('courseProgressBar');
                    if (progressBar) {
                        progressBar.style.width = result.progress + '%';
                        document.getElementById('progressText').textContent = result.progress + '%';
                    }
                    
                    // Use helper to update button state
                    updateMarkCompleteButton(true);

                    // Re-bind click event
                    btn.onclick = function() { nextLesson(); };

                    // Update local state
                    if(lessonsMap[currentLessonId]) lessonsMap[currentLessonId].isCompleted = true;

                    if (result.isCourseCompleted) {
                        const certBtn = document.getElementById('certificateBtn');
                        if(certBtn) {
                             if(result.certificateId) certBtn.href = '/Certificates/View/' + result.certificateId;
                             certBtn.classList.remove('d-none');
                        }
                        
                        // Also update main button if it starts existing (it might not be in DOM if conditioned by razor)
                        // If it is in DOM but hidden, we can show it?
                        // Actually, the main button below title is rendered nicely only if progress >= 100 on load.
                        // We can inject it or just rely on the top bar button. 
                        // Let's reload page? No, better show modal.
                        
                        // We can also update the review modal certificate link
                        // window.open(certBtn.href, '_blank'); // Maybe auto open? No, popups blocked.

                        new bootstrap.Modal(document.getElementById('reviewModal')).show();
                    }
                } else {
                    alert(result.message || "Could not complete lesson.");
                }
            } catch (error) {
                console.error("Error completing lesson:", error);
                alert(error.message || "An error occurred. Please try again.");
            } finally {
                btn.disabled = false;
                if (!lessonsMap[currentLessonId]?.isCompleted) { // Only reset if failed
                     // If failed, restore original state (Mark as Complete)
                     updateMarkCompleteButton(false);
                     btn.onclick = function() { markAsCompleted(); };
                }
            }
        }

        function nextLesson() {
            let found = false;
            let nextId = null;
            
            for (let m of modulesData) {
                for (let l of m.lessons) {
                    if (found) {
                        nextId = l.id;
                        break;
                    }
                    if (l.id === currentLessonId) {
                        found = true;
                    }
                }
                if (nextId) break;
            }
            
            if (nextId) {
                selectLesson(nextId);
            } else {
                alert("Congratulations! You have completed all lessons in this course.");
            }
        }

        // Search Filter
        function filterLessons() {
            const term = document.getElementById('lessonSearch').value.toLowerCase();
            document.querySelectorAll('.lesson-card').forEach(item => {
                const title = item.querySelector('h6').textContent.toLowerCase(); // Adjusted selector for title
                const parent = item.closest('.module-group'); // Corrected parent selector // This selector might need adjustment if module-item class is not on parent
                // Based on loop: class="module-group"
                const moduleGroup = item.closest('.module-group');

                if (title.includes(term)) {
                    item.classList.remove('d-none');
                    if (moduleGroup) moduleGroup.style.display = 'block';
                } else {
                    item.classList.add('d-none');
                }
            });
        }

        // Q&A Functions
        async function loadComments(lessonId) {
            const list = document.getElementById('commentsList');
            if(!list) return;
            
            list.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
            
            try {
                const response = await fetch(`?handler=Comments&lessonId=${lessonId}`);
                const comments = await response.json();
                
                if (!comments || comments.length === 0) {
                    list.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-chat-dots fs-1 d-block mb-2"></i><p>No questions yet. Be the first to ask!</p></div>';
                    return;
                }

                list.innerHTML = comments.map(c => renderComment(c)).join('');
            } catch (e) {
                list.innerHTML = '<p class="text-danger text-center">Failed to load discussions.</p>';
            }
        }

        function renderComment(c, isReply = false) {
            return `
                <div class="d-flex gap-3 mb-4 ${isReply ? 'ms-5 mt-3' : 'border-bottom pb-4'}">
                    <div class="flex-shrink-0">
                        <div class="avatar-circle bg-light text-primary fw-bold d-flex align-items-center justify-content-center rounded-circle border" style="width: 40px; height: 40px;">
                            ${c.username.charAt(0).toUpperCase()}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <span class="fw-bold text-dark">${c.username}</span>
                                ${c.isInstructor ? '<span class="badge bg-primary-subtle text-primary border border-primary-subtle ms-2 rounded-pill small">Instructor</span>' : ''}
                            </div>
                            <small class="text-muted">${new Date(c.createdAt).toLocaleDateString()}</small>
                        </div>
                        <p class="mb-2 text-secondary" style="font-size: 0.95rem;">${c.content}</p>
                        ${c.replies && c.replies.length ? c.replies.map(r => renderComment(r, true)).join('') : ''}
                    </div>
                </div>
            `;
        }

        async function submitComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            if (!content) return;

            const btn = document.getElementById('postCommentBtn');
            btn.disabled = true;
            
            try {
                const token = document.getElementsByName('__RequestVerificationToken')[0]?.value;
                const response = await fetch('?handler=PostComment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ lessonId: currentLessonId, content: content }) 
                });
                
                input.value = '';
                loadComments(currentLessonId);
            } catch(e) {
                alert('Failed to post comment');
            } finally {
                btn.disabled = false;
            }
        }

        // Review Submission
        async function submitReview() {
             const rating = document.getElementById('selectedRating').value;
             const comment = document.getElementById('reviewComment').value;
             if(rating == 0) { alert('Please select a star rating.'); return; }

             const token = document.getElementsByName('__RequestVerificationToken')[0]?.value;
             await fetch('?handler=SubmitReview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                body: JSON.stringify({ courseId: currentCourseId, rating: parseInt(rating), comment: comment }) 
             });
             
             bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
             alert('Review submitted! Thank you.');
             window.open(document.getElementById('certificateBtn').href, '_blank');
        }

        // Star Rating
        document.querySelectorAll('.rating-star').forEach(star => {
            star.onclick = function() {
                const r = this.dataset.rating;
                document.getElementById('selectedRating').value = r;
                document.querySelectorAll('.rating-star').forEach(s => {
                    s.classList.toggle('bi-star-fill', s.dataset.rating <= r);
                    s.classList.toggle('bi-star', s.dataset.rating > r);
                });
            };
        });
    </script>
    @Html.AntiForgeryToken()
</body>
</html>
